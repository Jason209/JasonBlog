<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<script type="text/javascript" src="scripts/jquery-1.7.1.min.js"></script>
<style type="text/css">
img{
	height:200px;
	display:block;
	border:5px solid #000;
}
</style>
<body>
<div id="gb_container">
<img needload="http://img.geekpark.net:83/uploads/reading/cover/BN4LNVESpyg1C2QElaqwvSHMmG3q8a7U.jpg" alt="" title="" />
<img needload="http://img.geekpark.net:83/uploads/reading/cover/TlNtaYt9P1RbMj0UMCkI6f7FkYSP4x7v.jpg" alt="" title="" />
<img needload="http://img.geekpark.net:83/uploads/reading/cover/FyTb973cMcRWNKSxe0MGXKj5CtUhBGx0.jpg" alt="" title="" />
<img needload="http://img.geekpark.net:83/uploads/reading/cover/m168S8ceIoULxqovFWA2zcRF0cVKD3A0.jpg" alt="" title="" />
<img needload="http://img.geekpark.net:83/uploads/reading/cover/Lj1GQ1A5tk62jcPRreOmL5Wm7mlURHF8.png"  alt="" title="" />
<img needload="http://img.geekpark.net:83/uploads/reading/cover/hw3MShG4qH6p1tbfmt0KCoMNWa7diRsa.jpg"   alt="" title="" />
<img needload="http://img.geekpark.net:83/uploads/reading/cover/86JdiaD3BVjtcR3fj2dXJRPcg2L29qpv.png"   alt="" title="" />
<img needload="http://img.geekpark.net:83/uploads/reading/cover/H4RdWPG06shJLuFdKRvAqKZ7C13NtNfH.jpg"  alt="" title="" />
</div>
<script type="text/javascript">
function ImagesDelay(container) {
    //离屏幕下方50像素内的图片加载
    var minBottom = 50;
    var srcData = new Array();
    var waitingUrl = "http://img.geekpark.net:83/uploads/reading/cover/H4RdWPG06shJLuFdKRvAqKZ7C13NtNfH.jpg";
    var lastBottomX = 0;

    //will server do
    //Replace src
    var imgs = $(container).find("img");
    var id = 0;
    imgs.each(function () {
        id++;
        var rect = this.getBoundingClientRect();
        $(this).attr("ld", "l" + id);
        srcData[srcData.length] = { "ld": "l" + id, "src": $(this).attr("needload"), "rect": rect };
        $(this).attr("src", waitingUrl);
    });
    $(window).scroll(function () {
        LoadImages();
    });
    // do first loading
    LoadImages();
	
	function LoadImages() {
        var bottomX = $(window).height() + $(window).scrollTop();
        if (lastBottomX <= bottomX) {
            lastBottomX = bottomX;
            var needData = GetNeedLoadImgs(bottomX);
            for (var i = 0; i < needData.length; i++) {
                var imgs = $(container).find("img[ld=" + needData[i].ld + "]");
                if (imgs.length > 0) {
                    LoadImage(imgs[0], needData[i].src);
                }

            }
        }
    }
    function GetNeedLoadImgs(bottomX) {
        var x = bottomX + minBottom;
        var result = new Array();
        var needLoad = new Array();
        for (var i = 0; i < srcData.length; i++) {
            var rect = srcData[i].rect;
            if (x >= rect.top) {
                result[result.length] = srcData[i];
            } else {
                needLoad[needLoad.length] = srcData[i];
            }
        }
        srcData = needLoad;
        return result;
    }
	function LoadImage(img, src) {
        var appname = navigator.appName.toLowerCase();
        if (appname.indexOf("netscape") == -1) {
            //ie
            img.onreadystatechange = function () {
                if (img.readyState == "complete") {
                    CalcRact();
                }
            };
        } else {
            //firefox
            img.onload = function () {
                if (img.complete == true) {
                    CalcRact();
                }
            }
        }
        img.src = src;
        if (img.width > 0 && img.complete) {
            CalcRact();
        }
    }
    function CalcRact() {
        for (var i = 0; i < srcData.length; i++) {
            var imgs = $(container).find("img[ld=" + srcData[i].ld + "]");
            if (imgs.length > 0) {
                srcData[i].rect = imgs[0].getBoundingClientRect();
            }
        }
    }  
}
var s = new ImagesDelay("#gb_container");

</script>
</body>
</html>

